<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz</title>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0b1220; --muted:#6b7280;
      --accent:#1f6feb; --ok:#16a34a; --ok-weak:#dcfce7; --warn:#b45309; --bad:#dc2626;
      --border:rgba(0,0,0,.12); --shadow:rgba(0,0,0,.08);
    }
    html[data-theme="dark"]{
      --bg:#000000; --card:#0b0b0f; --text:#f5f7ff; --muted:#a3a7b7;
      --accent:#7c9bff; --ok:#22c55e; --ok-weak:#062b14; --warn:#ffb02e; --bad:#ff6b6b;
      --border:rgba(255,255,255,.14); --shadow:rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--border)}
    html[data-theme="dark"] header{background:rgba(0,0,0,.7)}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:clamp(22px,2.6vw,32px)}
    .sub{color:var(--muted)}
    .bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-top:10px}
    input[type=text]{background:transparent;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px;outline:none}
    input[type=text]::placeholder{color:var(--muted)}
    button{background:var(--accent);border:none;color:#ffffff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px var(--shadow)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .icon-btn{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:999px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 8px 30px var(--shadow)}
    .card h3{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted)}
    .options{display:grid;gap:8px;margin-top:8px}
    .options label{
      display:grid;grid-template-columns:22px 1fr;gap:10px;align-items:start;
      padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;background:transparent;
      transition:transform .08s ease, box-shadow .08s ease, background .12s ease, border-color .12s ease, color .12s ease;
      box-shadow:0 2px 0 var(--shadow);
    }
    .options label:has(input[type=radio]:checked){
      background:var(--ok-weak); border-color:var(--ok); transform:translateY(1px);
      box-shadow:inset 0 2px 0 rgba(0,0,0,.06);
      color:#064e3b;
    }
    .options input[type=radio]{margin-top:3px}
    .writing{min-height:100px;width:100%;resize:vertical;background:transparent;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;font-size:12px}
    footer{border-top:1px solid var(--border);margin-top:24px;padding:20px;color:var(--muted)}
    .notice{border:1px dashed var(--border);padding:10px;border-radius:10px;color:var(--muted)}
    .hidden{display:none!important}
    .strike{opacity:.5;filter:grayscale(.3)}
    .small{font-size:12px}
    .timer{font-weight:800;letter-spacing:.5px}
    /* Modal de Consentimento */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      background:var(--card); color:var(--text);
      width:min(680px, 92vw); border:1px solid var(--border);
      border-radius:16px; padding:18px; box-shadow:0 20px 60px var(--shadow);
    }
    .modal h2{ margin:0 0 8px; }
    .modal .muted{ margin-bottom:10px; }
    .modal .rules{ background:rgba(0,0,0,.03); border:1px dashed var(--border); padding:12px; border-radius:12px; }
    .modal footer{ display:flex; gap:10px; justify-content:flex-end; border:0; padding:0; margin-top:14px;}
    .btn-ghost{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none;}
    /* Toast leve */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; background:#111827; color:#fff; padding:10px 14px;
      border-radius:12px; font-size:14px; box-shadow:0 8px 30px rgba(0,0,0,.35);
      z-index:9998; display:none;
    }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <!-- Modal de consentimento + nome (√∫nico popup) -->
  <div id="consentBackdrop" class="modal-backdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <h2>Quiz Terms</h2>
      <div class="muted">Enter your <b>full name</b> and click ‚ÄúAccept and start‚Äù. The timer begins immediately.</div>
      <label for="modalName" class="muted" style="display:block;margin:10px 0 6px">Full name</label>
      <input id="modalName" type="text" placeholder="Ex.: Maria Fernanda Silva" autocomplete="name"
             style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)" />
      <div class="rules" style="margin-top:12px">
        <ul>
          <li>We will attempt to activate <b>fullscreen</b> (if the browser allows).</li>
          <li>Tab/window switches are <b>recorded</b>.</li>
          <li><b>Copy/paste/cut</b> and <b>Ctrl/Cmd+F</b> are blocked.</li>
          <li>Do not minimize or close the tab until submitting the quiz.</li>
        </ul>
      </div>
      <footer>
        <button id="declineBtn" class="btn-ghost">Exit</button>
        <button id="acceptBtn" disabled>Accept and start</button>
      </footer>
    </div>
  </div>
  <div id="toast" class="toast" aria-live="polite">Action recorded.</div>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h1>Quiz ‚Äî Roger Williams & Thanksgiving</h1>
          <div class="sub">History (1620‚Äì1663)</div>
        </div>
        <button id="themeToggle" class="icon-btn">üåì Theme</button>
      </div>
      <div class="bar">
        <div class="row">
          <input id="studentName" type="text" placeholder="Name (filled upon acceptance)" autocomplete="name" />
          <span class="pill"><strong>Time:</strong> <span id="timer" class="timer">30:00</span></span>
          <span id="focusFlag" class="badge">Focus OK</span>
          <span id="tabCount" class="badge">Tab Counter: 0</span>
        </div>
        <div class="row">
          <input id="testId" type="text" placeholder="Quiz-Web-Designer1" />
          <button id="startBtn" class="hidden">Start</button>
          <button id="submitBtn" disabled>Submit</button>
        </div>
      </div>
      <div class="notice small" id="notes">
        The quiz will be submitted automatically in 30 minutes.
      </div>
    </div>
  </header>
  <main class="wrap">
    <form id="quizForm" class="grid" autocomplete="off">
      <!-- ===== 18 MULTIPLE CHOICE (q1‚Äìq13 and q16‚Äìq20) ===== -->
      <section class="card" data-difficulty="easy">
        <h3>Q1. In what year did the <i>Mayflower</i> arrive at Cape Cod (near present-day Massachusetts)?</h3>
        <div class="options">
          <label><input type="radio" name="q1" value="a"> a) 1607</label>
          <label><input type="radio" name="q1" value="b"> b) 1619</label>
          <label><input type="radio" name="q1" value="c" data-correct> c) 1620</label>
          <label><input type="radio" name="q1" value="d"> d) 1631</label>
          <label><input type="radio" name="q1" value="e"> e) 1636</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q2. Main reason the Pilgrims left England:</h3>
        <div class="options">
          <label><input type="radio" name="q2" value="a"> a) Gold</label>
          <label><input type="radio" name="q2" value="b"> b) Better climate</label>
          <label><input type="radio" name="q2" value="c" data-correct> c) Religious freedom</label>
          <label><input type="radio" name="q2" value="d"> d) Tobacco trade</label>
          <label><input type="radio" name="q2" value="e"> e) Tourism and adventure</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q3. The <i>Mayflower Compact</i> mainly established:</h3>
        <div class="options">
          <label><input type="radio" name="q3" value="a"> a) A local monarchy</label>
          <label><input type="radio" name="q3" value="b"> b) Full freedom of the press</label>
          <label><input type="radio" name="q3" value="c" data-correct> c) Self-government with ‚Äújust and equal laws‚Äù</label>
          <label><input type="radio" name="q3" value="d"> d) A standing army</label>
          <label><input type="radio" name="q3" value="e"> e) Trade treaty with Spain</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q4. Which indigenous nation helped the Pilgrims in the first year (1620‚Äì1621)?</h3>
        <div class="options">
          <label><input type="radio" name="q4" value="a" data-correct> a) Wampanoag</label>
          <label><input type="radio" name="q4" value="b"> b) Iroquois</label>
          <label><input type="radio" name="q4" value="c"> c) Cherokee</label>
          <label><input type="radio" name="q4" value="d"> d) Powhatan</label>
          <label><input type="radio" name="q4" value="e"> e) Mohawk</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q5. The 1621 encounter, linked to the ‚ÄúFirst Thanksgiving‚Äù, was essentially:</h3>
        <div class="options">
          <label><input type="radio" name="q5" value="a"> a) Royal military parade</label>
          <label><input type="radio" name="q5" value="b"> b) International trade fair</label>
          <label><input type="radio" name="q5" value="c" data-correct> c) A local harvest celebration after a difficult year</label>
          <label><input type="radio" name="q5" value="d"> d) Official national holiday decree</label>
          <label><input type="radio" name="q5" value="e"> e) Anglican coronation ceremony</label>
        </div>
      </section>
      <section class="card" data-difficulty="medium">
        <h3>Q6. A <b>documented</b> Wampanoag contribution to the 1621 gathering was:</h3>
        <div class="options">
          <label><input type="radio" name="q6" value="a" data-correct> a) Deer meat (venison)</label>
          <label><input type="radio" name="q6" value="b"> b) Mashed potatoes with butter</label>
          <label><input type="radio" name="q6" value="c"> c) Pumpkin pie</label>
          <label><input type="radio" name="q6" value="d"> d) Cranberry sauce with refined sugar</label>
          <label><input type="radio" name="q6" value="e"> e) Smoked turkey with gravy</label>
        </div>
      </section>
      <section class="card" data-difficulty="medium">
        <h3>Q7. The Wampanoag sachem/leader who formed an alliance with the Plymouth settlers was:</h3>
        <div class="options">
          <label><input type="radio" name="q7" value="a"> a) Canonicus</label>
          <label><input type="radio" name="q7" value="b"> b) Miantonomi</label>
          <label><input type="radio" name="q7" value="c" data-correct> c) Massasoit (Ousamequin)</label>
          <label><input type="radio" name="q7" value="d"> d) Powhatan</label>
          <label><input type="radio" name="q7" value="e"> e) Tecumseh</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q8. The settlement founded by the Pilgrims was named:</h3>
        <div class="options">
          <label><input type="radio" name="q8" value="a"> a) Jamestown</label>
          <label><input type="radio" name="q8" value="b" data-correct> b) Plymouth</label>
          <label><input type="radio" name="q8" value="c"> c) Providence</label>
          <label><input type="radio" name="q8" value="d"> d) New Amsterdam</label>
          <label><input type="radio" name="q8" value="e"> e) Salem</label>
        </div>
      </section>
      <section class="card" data-difficulty="medium">
        <h3>Q9. ‚ÄúThanksgiving‚Äù as a national proclamation in the U.S., during the Civil War, was issued by:</h3>
        <div class="options">
          <label><input type="radio" name="q9" value="a"> a) George Washington</label>
          <label><input type="radio" name="q9" value="b" data-correct> b) Abraham Lincoln (1863)</label>
          <label><input type="radio" name="q9" value="c"> c) Thomas Jefferson</label>
          <label><input type="radio" name="q9" value="d"> d) Franklin D. Roosevelt</label>
          <label><input type="radio" name="q9" value="e"> e) John Adams</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q10. Roger Williams arrived in New England in:</h3>
        <div class="options">
          <label><input type="radio" name="q10" value="a"> a) 1620</label>
          <label><input type="radio" name="q10" value="b" data-correct> b) 1631</label>
          <label><input type="radio" name="q10" value="c"> c) 1635</label>
          <label><input type="radio" name="q10" value="d"> d) 1636</label>
          <label><input type="radio" name="q10" value="e"> e) 1644</label>
        </div>
      </section>
      <section class="card" data-difficulty="medium">
        <h3>Q11. The main reason for his banishment from Massachusetts Bay (1635) was:</h3>
        <div class="options">
          <label><input type="radio" name="q11" value="a"> a) Theft</label>
          <label><input type="radio" name="q11" value="b"> b) Plagiarism</label>
          <label><input type="radio" name="q11" value="c" data-correct> c) ‚ÄúDangerous‚Äù ideas about freedom of conscience and Church‚ÄìState separation</label>
          <label><input type="radio" name="q11" value="d"> d) Military desertion</label>
          <label><input type="radio" name="q11" value="e"> e) Tobacco smuggling</label>
        </div>
      </section>
      <section class="card" data-difficulty="hard">
        <h3>Q12. In the winter of 1635‚Äì1636, Roger Williams found shelter and support mainly:</h3>
        <div class="options">
          <label><input type="radio" name="q12" value="a"> a) In Boston, by colonial officials</label>
          <label><input type="radio" name="q12" value="b" data-correct> b) With Wampanoag sachem Massasoit, in Sowams</label>
          <label><input type="radio" name="q12" value="c"> c) Aboard a Dutch ship</label>
          <label><input type="radio" name="q12" value="d"> d) In an English fort</label>
          <label><input type="radio" name="q12" value="e"> e) In Jamestown, Virginia</label>
        </div>
      </section>
      <section class="card" data-difficulty="hard">
        <h3>Q13. In spring 1636, Roger Williams <b>purchased</b> land to found Providence from which leaders?</h3>
        <div class="options">
          <label><input type="radio" name="q13" value="a"> a) Powhatan and Pocahontas</label>
          <label><input type="radio" name="q13" value="b" data-correct> b) Canonicus and Miantonomi (Narragansett)</label>
          <label><input type="radio" name="q13" value="c"> c) Metacom (King Philip) and Tecumseh</label>
          <label><input type="radio" name="q13" value="d"> d) John Winthrop and William Bradford</label>
          <label><input type="radio" name="q13" value="e"> e) Anne Hutchinson and John Cotton</label>
        </div>
      </section>
      <!-- ===== 2 OPEN-ENDED (q14, q15) ‚Äî names preserved ===== -->
      <section class="card" data-difficulty="writing">
        <h3>Q14. In 2‚Äì3 sentences, explain how <b>God‚Äôs Providence</b> appears in both the 1621 harvest and Roger Williams‚Äô rescue in the winter of 1635‚Äì1636.</h3>
        <textarea name="q14" class="writing" placeholder="Write your answer..."></textarea>
      </section>
      <section class="card" data-difficulty="writing">
        <h3>Q15. Describe one practical act of ‚ÄúThanksgiving‚Äù today that reflects these stories (sharing, hospitality, justice, gratitude).</h3>
        <textarea name="q15" class="writing" placeholder="Write your answer..."></textarea>
      </section>
      <!-- ===== Back to multiple choice (q16‚Äìq20) ===== -->
      <section class="card" data-difficulty="medium">
        <h3>Q16. The name ‚ÄúProvidence‚Äù was chosen by Roger Williams to acknowledge:</h3>
        <div class="options">
          <label><input type="radio" name="q16" value="a"> a) An English military victory</label>
          <label><input type="radio" name="q16" value="b" data-correct> b) God‚Äôs providence in guiding and sustaining him</label>
          <label><input type="radio" name="q16" value="c"> c) Homage to King Charles II</label>
          <label><input type="radio" name="q16" value="d"> d) A European city of the same name</label>
          <label><input type="radio" name="q16" value="e"> e) A famous sea route</label>
        </div>
      </section>
      <section class="card" data-difficulty="medium">
        <h3>Q17. The 1663 Royal Charter (Rhode Island and Providence Plantations) mainly guaranteed:</h3>
        <div class="options">
          <label><input type="radio" name="q17" value="a"> a) Hereditary governor</label>
          <label><input type="radio" name="q17" value="b"> b) Standing army</label>
          <label><input type="radio" name="q17" value="c" data-correct> c) Broad religious freedom/tolerance</label>
          <label><input type="radio" name="q17" value="d"> d) Exclusive trade with the Netherlands</label>
          <label><input type="radio" name="q17" value="e"> e) Mandatory religious censorship</label>
        </div>
      </section>
      <section class="card" data-difficulty="hard">
        <h3>Q18. Which principle did Roger Williams <b>vehemently defend</b>?</h3>
        <div class="options">
          <label><input type="radio" name="q18" value="a"> a) Religious tests for voting</label>
          <label><input type="radio" name="q18" value="b" data-correct> b) Separation of Church and State</label>
          <label><input type="radio" name="q18" value="c"> c) Mandatory church attendance</label>
          <label><input type="radio" name="q18" value="d"> d) Exile of dissenters</label>
          <label><input type="radio" name="q18" value="e"> e) Prohibition of land purchase</label>
        </div>
      </section>
      <section class="card" data-difficulty="medium">
        <h3>Q19. Providence is located in the region of:</h3>
        <div class="options">
          <label><input type="radio" name="q19" value="a"> a) Chesapeake Bay (Virginia)</label>
          <label><input type="radio" name="q19" value="b" data-correct> b) Narragansett Bay (present-day Rhode Island)</label>
          <label><input type="radio" name="q19" value="c"> c) Hudson Bay</label>
          <label><input type="radio" name="q19" value="d"> d) Delaware Bay</label>
          <label><input type="radio" name="q19" value="e"> e) Massachusetts Bay</label>
        </div>
      </section>
      <section class="card" data-difficulty="easy">
        <h3>Q20. Roger Williams helped start, in 1638/1639, the church known as:</h3>
        <div class="options">
          <label><input type="radio" name="q20" value="a"> a) Old North Church (Boston)</label>
          <label><input type="radio" name="q20" value="b"> b) St. Paul‚Äôs Chapel (NY)</label>
          <label><input type="radio" name="q20" value="c" data-correct> c) First Baptist Church of Providence</label>
          <label><input type="radio" name="q20" value="d"> d) Trinity Church (Newport)</label>
          <label><input type="radio" name="q20" value="e"> e) King‚Äôs Chapel (Boston)</label>
        </div>
      </section>
      <!-- Admin -->
      <div class="card">
        <h3>Results & Admin</h3>
        <p class="muted small">Teacher only.</p>
        <div class="row" style="margin-top:10px">
          <button id="downloadCsvBtn" disabled>Download CSV</button>
          <button id="resetBtn" class="icon-btn">Reset</button>
        </div>
      </div>
      <footer>
        <div class="small">Designed by MF Bruno, your MF teacher! Hey yo...</div>
      </footer>
    </form>
  </main>
  <script>
  // ===== Theme =====
  (function(){
    const root = document.documentElement;
    const saved = localStorage.getItem('theme') || 'light';
    root.setAttribute('data-theme', saved);
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
  })();
  // ===== Config =====
  const DEFAULT_MINUTES = 30;
  const ENDPOINT = 'https://script.google.com/macisdiction/s/AKfycbzWovrGHidKrd0HCXmH5BgGn-7_D-T_-VhWQ1IKXh68W1cvp4Q1s9d8WVLckKvy5fn96g/exec';
  // ===== State =====
  let started = false, ended = false;
  let startTime = null, endTime = null, timerInterval = null;
  let secondsLeft = DEFAULT_MINUTES * 60;
  // Anti-cheat
  let tabSwitches = 0, blurCount = 0, isBlurred = false, blurStart = null, totalBlurMs = 0;
  let copyCount = 0, pasteCount = 0, findCount = 0;
  // desconto de 1 logo ap√≥s aceitar (popup do sistema)
  let acceptTs = null;
  const GRACE_MS = 2500;
  let systemPopupOffsetApplied = false;
  // DOM
  const startBtn = document.getElementById('startBtn');
  const submitBtn = document.getElementById('submitBtn');
  const timerEl = document.getElementById('timer');
  const form = document.getElementById('quizForm');
  const nameInput = document.getElementById('studentName');
  const testIdInput = document.getElementById('testId');
  const focusFlag = document.getElementById('focusFlag');
  const tabCountEl = document.getElementById('tabCount');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const resetBtn = document.getElementById('resetBtn');
  const toast = document.getElementById('toast');
  // Modal
  const consentBackdrop = document.getElementById('consentBackdrop');
  const modalName = document.getElementById('modalName');
  const acceptBtnEl = document.getElementById('acceptBtn');
  document.body.style.overflow = 'hidden'; // trava scroll enquanto modal existe
  // trava o form at√© iniciar
  [...form.elements].forEach(el=>el.disabled = true);
  function fmt(secs){
    const m = Math.floor(secs/60).toString().padStart(2,'0');
    const s = (secs%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }
  function tick(){
    secondsLeft--; if(secondsLeft < 0){ secondsLeft = 0; }
    timerEl.textContent = fmt(secondsLeft);
    if(secondsLeft === 0){ autoSubmit('time'); }
  }
  function startTimer(){
    clearInterval(timerInterval);
    timerInterval = setInterval(tick, 1000);
  }
  async function goFullscreen(){
    try{
      if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
        await document.documentElement.requestFullscreen();
      }
    }catch(e){}
  }
  function showToast(msg){
    toast.textContent = msg || 'Action recorded.';
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 1500);
  }
  function maybeApplySystemPopupOffset(){
    if (started && !systemPopupOffsetApplied && acceptTs && (Date.now() - acceptTs) <= GRACE_MS){
      tabSwitches = Math.max(0, tabSwitches - 1);
      systemPopupOffsetApplied = true;
      tabCountEl.textContent = `Tab Counter: ${tabSwitches}`;
    }
  }
  function isValidFullName(n){
    const t = (n||'').trim().replace(/\s+/g,' ');
    const parts = t.split(' ').filter(p => p.length >= 2);
    return parts.length >= 2;
  }
  // habilita o bot√£o quando o nome √© v√°lido
  modalName.addEventListener('input', ()=>{
    acceptBtnEl.disabled = !isValidFullName(modalName.value);
  });
  function startTest(){
    started = true; startTime = new Date();
    nameInput.disabled = true; // fica somente leitura ap√≥s iniciar
    testIdInput.disabled = true;
    startBtn.disabled = true; startBtn.classList.add('hidden');
    submitBtn.disabled = false;
    // habilita formul√°rio
    [...form.elements].forEach(el=>el.disabled = false);
    setTimeout(()=>{ [...form.elements].forEach(el=>el.disabled=false); }, 0);
    startTimer();
    // bloqueios (apenas ap√≥s iniciar)
    document.addEventListener('copy', (e)=>{ copyCount++; e.preventDefault(); showToast('Copy blocked.'); });
    document.addEventListener('cut', (e)=>{ e.preventDefault(); showToast('Cut blocked.'); });
    document.addEventListener('paste', (e)=>{ pasteCount++; e.preventDefault(); showToast('Paste blocked.'); });
    document.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      const ctrl = e.ctrlKey || e.metaKey;
      if (ctrl && (k==='c' || k==='v' || k==='x' || k==='s' || k==='p' || k==='f')) { e.preventDefault(); showToast('Shortcut blocked.'); }
      if (k==='f11'){ e.preventDefault(); showToast('F11 blocked.'); }
    }, {capture:true});
    document.addEventListener('contextmenu', (e)=> e.preventDefault());
    document.addEventListener('fullscreenchange', ()=>{
      if (started && !ended && !document.fullscreenElement){
        // n√£o for√ßa novamente para evitar novo popup
      }
    });
  }
  function grade(){
    const answers = {}; let totalCorrect = 0, totalPossible = 0;
    const byDiff = {easy:0, medium:0, hard:0};
    const possibleByDiff = {easy:0, medium:0, hard:0};
    const nodes = form.querySelectorAll('section.card');
    nodes.forEach((sec)=>{
      const diff = sec.dataset.difficulty;
      if(diff === 'writing') return;
      const radios = sec.querySelectorAll('input[type=radio]');
      if (!radios.length) return;
      const qname = radios[0].name;
      const checked = sec.querySelector('input[type=radio]:checked');
      const correct = sec.querySelector('input[type=radio][data-correct]');
      const isCorrect = !!(checked && correct && checked === correct);
      answers[qname] = checked ? checked.value : null;
      if (diff in possibleByDiff) possibleByDiff[diff]++;
      if (isCorrect){ totalCorrect++; if (diff in byDiff) byDiff[diff]++; }
      totalPossible++;
    });
    const writing = {
      q14: form.querySelector('[name=q14]')?.value.trim() || '',
      q15: form.querySelector('[name=q15]')?.value.trim() || ''
    };
    return {
      answers, writing,
      score: { totalCorrect, totalPossible, byDifficulty: byDiff, possibleByDifficulty: possibleByDiff }
    };
  }
  function collectPayload(reason='manual'){
    const g = grade();
    const now = new Date();
    const studentNameSafe = (nameInput.value || '').trim() || '(no name)';
    return {
      testId: (testIdInput.value.trim() || 'Module3-Revolution-Quiz-v1'),
      studentName: studentNameSafe,
      startISO: startTime?.toISOString() || null,
      endISO: now.toISOString(),
      durationSec: startTime ? Math.round((now - startTime)/1000) : null,
      reason,
      score: g.score,
      answers: g.answers,
      writing: g.writing,
      focus: { tabSwitches, blurCount, totalBlurMs, copyCount, pasteCount, findCount }
    };
  }
  function toCSV(obj){
    const s = obj;
    const row = [
      new Date().toISOString(), s.testId, JSON.stringify(s.studentName), s.startISO, s.endISO, s.durationSec,
      s.score.totalCorrect, s.score.totalPossible,
      s.score.byDifficulty.easy, s.score.byDifficulty.medium, s.score.byDifficulty.hard,
      s.focus.tabSwitches, s.focus.blurCount, s.focus.totalBlurMs, s.focus.copyCount, s.focus.pasteCount, s.focus.findCount,
      JSON.stringify(s.answers), JSON.stringify(s.writing)
    ];
    const header = [
      'timestamp','testId','studentName','startISO','endISO','durationSec','correct','possible','easyCorrect','mediumCorrect','hardCorrect','tabSwitches','blurCount','totalBlurMs','copyCount','pasteCount','findCount','answers','writing'
    ];
    return header.join(',') + '\n' + row.join(',');
  }
  async function sendResults(payload){
    try{
      const res = await fetch(ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain' },
        body: JSON.stringify(payload)
      });
      return { posted: res.ok, status: res.status };
    }catch(err){
      console.warn('POST failed', err);
      return { posted:false, error: String(err) };
    }
  }
  function downloadCSV(name, csv){
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${(name||'anonymous').replace(/\s+/g,'_')}_Module5_Quiz.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }
  function lockTest(){
    [...form.elements].forEach(el=>el.disabled = true);
    submitBtn.disabled = true; downloadCsvBtn.disabled = false;
    document.getElementById('notes').textContent = 'Locked. Answers recorded.';
    document.querySelectorAll('section.card').forEach(sec=>sec.classList.add('strike'));
  }
  async function finalize(reason){
    if(ended) return; ended = true; endTime = new Date(); clearInterval(timerInterval);
    const payload = collectPayload(reason);
    const csv = toCSV(payload);
    const postRes = await sendResults(payload);
    downloadCSV(payload.studentName || 'anonymous', csv);
    lockTest();
    try{ if(document.fullscreenElement) document.exitFullscreen(); }catch(e){}
    console.log('Result payload:', payload, 'POST:', postRes);
  }
  function autoSubmit(reason){ finalize(reason); }
  // Eventos b√°sicos
  startBtn.addEventListener('click', startTest);
  submitBtn.addEventListener('click', ()=> finalize('manual'));

  downloadCsvBtn.addEventListener('click', ()=>{
    const csv = toCSV(collectPayload('download-only'));
    downloadCSV((nameInput.value || '').trim() || 'anonymous', csv);
  });
  resetBtn.addEventListener('click', ()=>{ location.reload(); });
  // Anti-cheat + offset popup
  document.addEventListener('visibilitychange', ()=>{
    if(!started || ended) return;
    if(document.visibilityState === 'hidden'){
      tabSwitches++; tabCountEl.textContent = `Tab Counter: ${tabSwitches}`;
      focusFlag.textContent = 'Focus LOST';
      isBlurred = true; blurStart = Date.now();
      maybeApplySystemPopupOffset();
      showToast('Tab switch recorded.');
    } else {
      focusFlag.textContent = 'Focus OK';
      if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
    }
  });
  window.addEventListener('blur', ()=>{
    if(!started || ended) return;
    blurCount++;
    if (document.visibilityState !== 'hidden') {
      tabSwitches++; tabCountEl.textContent = `Tab Counter: ${tabSwitches}`;
      maybeApplySystemPopupOffset();
    }
    focusFlag.textContent='Focus LOST'; isBlurred=true; blurStart=Date.now();
  });
  window.addEventListener('focus', ()=>{
    if(!started || ended) return;
    focusFlag.textContent='Focus OK';
    if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
  });
  window.addEventListener('pagehide', ()=>{
    if(!started || ended) return;
    tabSwitches++; tabCountEl.textContent = `Tab Counter: ${tabSwitches}`;
    maybeApplySystemPopupOffset();
    if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
  });
  // Aceitar/Sair do modal
  document.getElementById('acceptBtn').addEventListener('click', async ()=>{
    const fullName = (modalName.value || '').trim();
    const t = fullName.replace(/\s+/g,' ');
    const parts = t.split(' ').filter(p => p.length >= 2);
    if(parts.length < 2){
      modalName.setAttribute('aria-invalid','true');
      modalName.focus();
      return;
    }
    // Preenche o nome vis√≠vel no topo e bloqueia depois ao iniciar
    document.getElementById('studentName').value = t;
    // remove overlay (impede travamento)
    const backdrop = document.getElementById('consentBackdrop');
    if (backdrop) backdrop.remove();
    document.body.style.overflow = '';
    acceptTs = Date.now();
    startTest(); // inicia j√°
    try{ await goFullscreen(); }catch(e){}
  });
  document.getElementById('declineBtn').addEventListener('click', ()=>{
    window.location.href = 'about:blank';
  });
  // enquanto o modal existe, bloqueia atalhos que poderiam atrapalhar
  document.addEventListener('keydown', (e)=>{
    if (document.getElementById('consentBackdrop')){
      const k = e.key.toLowerCase();
      if ((e.ctrlKey||e.metaKey) && (k==='w' || k==='r' || k==='p' || k==='s' || k==='f')) e.preventDefault();
      if (k==='f11') e.preventDefault();
    }
  });
  // bloqueio global do menu de contexto
  document.addEventListener('contextmenu', (e)=> e.preventDefault());
  </script>
</body>
</html>
