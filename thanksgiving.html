<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pilgrims & Roger Williams ‚Äì Quiz</title>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0b1220; --muted:#6b7280;
      --accent:#1f6feb; --ok:#16a34a; --ok-weak:#dcfce7; --warn:#b45309; --bad:#dc2626;
      --border:rgba(0,0,0,.12); --shadow:rgba(0,0,0,.08);
    }
    html[data-theme="dark"]{
      --bg:#000000; --card:#0b0b0f; --text:#f5f7ff; --muted:#a3a7b7;
      --accent:#7c9bff; --ok:#22c55e; --ok-weak:#062b14; --warn:#ffb02e; --bad:#ff6b6b;
      --border:rgba(255,255,255,.14); --shadow:rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--border)}
    html[data-theme="dark"] header{background:rgba(0,0,0,.7)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:clamp(22px,2.6vw,32px)}
    .sub{color:var(--muted)}
    .bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-top:10px}
    input[type=text]{background:transparent;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;min-width:240px;outline:none}
    input[type=text]::placeholder{color:var(--muted)}
    button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px var(--shadow)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .icon-btn{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:999px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 8px 30px var(--shadow)}
    .card h3{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted)}
    .options{display:grid;gap:8px;margin-top:8px}
    .options label{
      display:grid;grid-template-columns:22px 1fr;gap:10px;align-items:start;
      padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;background:transparent;
      transition:transform .08s ease, background .12s ease, border-color .12s ease, color .12s ease;
      box-shadow:0 2px 0 var(--shadow);
    }
    .options label:has(input[type=radio]:checked){
      background:var(--ok-weak); border-color:var(--ok); transform:translateY(1px);
      box-shadow:inset 0 2px 0 rgba(0,0,0,.06); color:#064e3b;
    }
    .writing{min-height:90px;width:100%;resize:vertical;background:transparent;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
    .small{font-size:12px}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;font-size:12px}
    .notice{border:1px dashed var(--border);padding:10px;border-radius:10px;color:var(--muted)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;font-size:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);z-index:9998;display:none}
    .toast.show{display:block}
    .strike{opacity:.5;filter:grayscale(.3)}
    footer{border-top:1px solid var(--border);margin-top:24px;padding:20px;color:var(--muted)}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);color:var(--text);width:min(640px,92vw);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 20px 60px var(--shadow)}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;border:0;padding:0;margin-top:14px}
  </style>
</head>
<body>
  <!-- Modal de consentimento -->
  <div id="consentBackdrop" class="modal-backdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <h2>Pilgrims & Roger Williams ‚Äî Quiz</h2>
      <div class="muted">Preencha seu <b>nome completo</b> e clique em ‚ÄúAceitar e come√ßar‚Äù. O cron√¥metro inicia em seguida.</div>
      <label class="muted" style="display:block;margin:10px 0 6px">Nome completo</label>
      <input id="modalName" type="text" placeholder="Ex.: Maria Fernanda Silva" autocomplete="name"
             style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)" />
      <div class="notice small" style="margin-top:12px">
        <ul>
          <li>Trocas de aba/janela s√£o registradas.</li>
          <li>Copiar/colar/recortar e Ctrl/Cmd+F s√£o bloqueados.</li>
        </ul>
      </div>
      <footer>
        <button id="declineBtn" class="icon-btn">Sair</button>
        <button id="acceptBtn" disabled>Aceitar e come√ßar</button>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite">A√ß√£o registrada.</div>

  <header>
    <div class="wrap">
      <div class="bar">
        <div>
          <h1>Pilgrims & Roger Williams</h1>
          <div class="sub">History ‚Äî sele√ß√£o √∫nica (a‚Äìe) + 2 respostas abertas.</div>
        </div>
        <button id="themeToggle" class="icon-btn">üåì Tema</button>
      </div>

      <div class="bar" style="margin-top:8px">
        <div class="row">
          <input id="studentName" type="text" placeholder="Nome (preenchido ao aceitar)" autocomplete="name" />
          <span class="pill"><strong>Tempo:</strong> <span id="timer" class="timer">30:00</span></span>
          <span id="focusFlag" class="badge">Foco OK</span>
          <span id="tabCount" class="badge">Contador de Aba: 0</span>
        </div>
        <div class="row">
          <input id="testId" type="text" placeholder="Pilgrims-Roger-Quiz-v1" />
          <button id="submitBtn" disabled>Enviar</button>
        </div>
      </div>

      <div class="notice small" id="notes">A prova ser√° enviada automaticamente em 30 minutos.</div>
    </div>
  </header>

  <main class="wrap">
    <form id="quizForm" class="grid" autocomplete="off">
      <!-- 1 -->
      <section class="card">
        <h3>Q1. Who were the Pilgrims that sailed on the Mayflower (1620)?</h3>
        <div class="options">
          <label><input type="radio" name="q1" value="a"> a) Puritans staying within the Church of England</label>
          <label><input type="radio" name="q1" value="b" data-correct> b) Separatists seeking to form independent congregations</label>
          <label><input type="radio" name="q1" value="c"> c) Quakers led by William Penn</label>
          <label><input type="radio" name="q1" value="d"> d) Catholics fleeing Maryland</label>
          <label><input type="radio" name="q1" value="e"> e) French Huguenots</label>
        </div>
      </section>
      <!-- 2 -->
      <section class="card">
        <h3>Q2. Before crossing the Atlantic, the Pilgrims lived for years in</h3>
        <div class="options">
          <label><input type="radio" name="q2" value="a"> a) Dublin</label>
          <label><input type="radio" name="q2" value="b"> b) Lisbon</label>
          <label><input type="radio" name="q2" value="c" data-correct> c) Leiden (Netherlands)</label>
          <label><input type="radio" name="q2" value="d"> d) Geneva</label>
          <label><input type="radio" name="q2" value="e"> e) Hamburg</label>
        </div>
      </section>
      <!-- 3 -->
      <section class="card">
        <h3>Q3. The Mayflower Compact (1620) is best described as</h3>
        <div class="options">
          <label><input type="radio" name="q3" value="a"> a) A trade treaty with France</label>
          <label><input type="radio" name="q3" value="b"> b) A royal charter from King James I</label>
          <label><input type="radio" name="q3" value="c" data-correct> c) A covenant for self-government by the settlers</label>
          <label><input type="radio" name="q3" value="d"> d) A military alliance with Wampanoag</label>
          <label><input type="radio" name="q3" value="e"> e) A plan to abolish slavery</label>
        </div>
      </section>
      <!-- 4 -->
      <section class="card">
        <h3>Q4. The colony established by the Mayflower group was</h3>
        <div class="options">
          <label><input type="radio" name="q4" value="a"> a) Jamestown</label>
          <label><input type="radio" name="q4" value="b" data-correct> b) Plymouth</label>
          <label><input type="radio" name="q4" value="c"> c) Providence</label>
          <label><input type="radio" name="q4" value="d"> d) New Amsterdam</label>
          <label><input type="radio" name="q4" value="e"> e) Salem</label>
        </div>
      </section>
      <!-- 5 -->
      <section class="card">
        <h3>Q5. Who helped the Pilgrims learn local agriculture and survive the first year?</h3>
        <div class="options">
          <label><input type="radio" name="q5" value="a"> a) Pocahontas</label>
          <label><input type="radio" name="q5" value="b" data-correct> b) Squanto (Tisquantum)</label>
          <label><input type="radio" name="q5" value="c"> c) Tecumseh</label>
          <label><input type="radio" name="q5" value="d"> d) Sacagawea</label>
          <label><input type="radio" name="q5" value="e"> e) Geronimo</label>
        </div>
      </section>
      <!-- 6 -->
      <section class="card">
        <h3>Q6. The 1621 harvest celebration often linked to ‚ÄúThanksgiving‚Äù involved the Pilgrims and the</h3>
        <div class="options">
          <label><input type="radio" name="q6" value="a"> a) Iroquois</label>
          <label><input type="radio" name="q6" value="b" data-correct> b) Wampanoag</label>
          <label><input type="radio" name="q6" value="c"> c) Cherokee</label>
          <label><input type="radio" name="q6" value="d"> d) Sioux</label>
          <label><input type="radio" name="q6" value="e"> e) Apache</label>
        </div>
      </section>
      <!-- 7 -->
      <section class="card">
        <h3>Q7. A central idea of the Mayflower Compact was</h3>
        <div class="options">
          <label><input type="radio" name="q7" value="a" data-correct> a) government derives its power from the consent of the governed</label>
          <label><input type="radio" name="q7" value="b"> b) divine right of kings</label>
          <label><input type="radio" name="q7" value="c"> c) mercantilism</label>
          <label><input type="radio" name="q7" value="d"> d) separation of powers</label>
          <label><input type="radio" name="q7" value="e"> e) judicial review</label>
        </div>
      </section>
      <!-- 8 -->
      <section class="card">
        <h3>Q8. William Bradford is best remembered as</h3>
        <div class="options">
          <label><input type="radio" name="q8" value="a"> a) founder of Providence</label>
          <label><input type="radio" name="q8" value="b" data-correct> b) long-time governor and historian of Plymouth</label>
          <label><input type="radio" name="q8" value="c"> c) author of Common Sense</label>
          <label><input type="radio" name="q8" value="d"> d) leader of Jamestown</label>
          <label><input type="radio" name="q8" value="e"> e) Dutch merchant in Leiden</label>
        </div>
      </section>
      <!-- 9 -->
      <section class="card">
        <h3>Q9. Roger Williams was banished from Massachusetts Bay mainly because he</h3>
        <div class="options">
          <label><input type="radio" name="q9" value="a"> a) supported monarchy</label>
          <label><input type="radio" name="q9" value="b" data-correct> b) defended liberty of conscience and separation of church and state</label>
          <label><input type="radio" name="q9" value="c"> c) advocated slavery</label>
          <label><input type="radio" name="q9" value="d"> d) was a Quaker missionary</label>
          <label><input type="radio" name="q9" value="e"> e) opposed trial by jury</label>
        </div>
      </section>
      <!-- 10 -->
      <section class="card">
        <h3>Q10. In winter 1636, fleeing in snow, Williams was aided first near Sowams by allies of the sachem</h3>
        <div class="options">
          <label><input type="radio" name="q10" value="a"> a) Canonicus of the Pequot</label>
          <label><input type="radio" name="q10" value="b" data-correct> b) Massasoit (Wampanoag)</label>
          <label><input type="radio" name="q10" value="c"> c) Powhatan</label>
          <label><input type="radio" name="q10" value="d"> d) Pontiac</label>
          <label><input type="radio" name="q10" value="e"> e) Sitting Bull</label>
        </div>
      </section>
      <!-- 11 -->
      <section class="card">
        <h3>Q11. With Narragansett permission, Roger Williams founded Providence in</h3>
        <div class="options">
          <label><input type="radio" name="q11" value="a"> a) 1620</label>
          <label><input type="radio" name="q11" value="b"> b) 1630</label>
          <label><input type="radio" name="q11" value="c" data-correct> c) 1636</label>
          <label><input type="radio" name="q11" value="d"> d) 1644</label>
          <label><input type="radio" name="q11" value="e"> e) 1663</label>
        </div>
      </section>
      <!-- 12 -->
      <section class="card">
        <h3>Q12. Which principle was most associated with Williams‚Äôs Providence?</h3>
        <div class="options">
          <label><input type="radio" name="q12" value="a" data-correct> a) freedom of religion for all (liberty of conscience)</label>
          <label><input type="radio" name="q12" value="b"> b) state-established church</label>
          <label><input type="radio" name="q12" value="c"> c) hereditary aristocracy</label>
          <label><input type="radio" name="q12" value="d"> d) absolute monarchy</label>
          <label><input type="radio" name="q12" value="e"> e) military rule</label>
        </div>
      </section>
      <!-- 13 -->
      <section class="card">
        <h3>Q13. Williams insisted that land should be acquired from Native peoples by</h3>
        <div class="options">
          <label><input type="radio" name="q13" value="a"> a) royal decree</label>
          <label><input type="radio" name="q13" value="b" data-correct> b) fair purchase/consent</label>
          <label><input type="radio" name="q13" value="c"> c) conquest</label>
          <label><input type="radio" name="q13" value="d"> d) church tithe</label>
          <label><input type="radio" name="q13" value="e"> e) lottery</label>
        </div>
      </section>
      <!-- 14 -->
      <section class="card">
        <h3>Q14. The 1644 charter (and later 1663) helped secure for Rhode Island</h3>
        <div class="options">
          <label><input type="radio" name="q14" value="a"> a) exclusive trade with Spain</label>
          <label><input type="radio" name="q14" value="b"> b) abolition of slavery</label>
          <label><input type="radio" name="q14" value="c" data-correct> c) legal protection for religious liberty/governance</label>
          <label><input type="radio" name="q14" value="d"> d) union with Connecticut</label>
          <label><input type="radio" name="q14" value="e"> e) royal governorship</label>
        </div>
      </section>
      <!-- 15 -->
      <section class="card">
        <h3>Q15. Which statement is most accurate about Separatists vs. Puritans?</h3>
        <div class="options">
          <label><input type="radio" name="q15" value="a"> a) Separatists wanted to reform the church from within</label>
          <label><input type="radio" name="q15" value="b" data-correct> b) Puritans wanted reform; Separatists left to form independent churches</label>
          <label><input type="radio" name="q15" value="c"> c) Both supported royal supremacy</label>
          <label><input type="radio" name="q15" value="d"> d) Both opposed any reform</label>
          <label><input type="radio" name="q15" value="e"> e) Neither migrated to New England</label>
        </div>
      </section>
      <!-- 16 -->
      <section class="card">
        <h3>Q16. The ship that initially failed to cross with the Mayflower was the</h3>
        <div class="options">
          <label><input type="radio" name="q16" value="a"> a) Susan Constant</label>
          <label><input type="radio" name="q16" value="b"> b) Discovery</label>
          <label><input type="radio" name="q16" value="c" data-correct> c) Speedwell</label>
          <label><input type="radio" name="q16" value="d"> d) Godspeed</label>
          <label><input type="radio" name="q16" value="e"> e) Half Moon</label>
        </div>
      </section>
      <!-- 17 -->
      <section class="card">
        <h3>Q17. Which best connects ‚ÄúThanksgiving‚Äù to a key value for community life?</h3>
        <div class="options">
          <label><input type="radio" name="q17" value="a" data-correct> a) Gratitude and mutual aid among diverse peoples</label>
          <label><input type="radio" name="q17" value="b"> b) Military victory over New France</label>
          <label><input type="radio" name="q17" value="c"> c) Monopolies over corn trade</label>
          <label><input type="radio" name="q17" value="d"> d) Royal taxation</label>
          <label><input type="radio" name="q17" value="e"> e) Judicial supremacy</label>
        </div>
      </section>
      <!-- 18 -->
      <section class="card">
        <h3>Q18. Which Native nation‚Äôs leaders Canonicus and Miantonomi supported Williams?</h3>
        <div class="options">
          <label><input type="radio" name="q18" value="a"> a) Wampanoag</label>
          <label><input type="radio" name="q18" value="b" data-correct> b) Narragansett</label>
          <label><input type="radio" name="q18" value="c"> c) Pequot</label>
          <label><input type="radio" name="q18" value="d"> d) Mohawk</label>
          <label><input type="radio" name="q18" value="e"> e) Shawnee</label>
        </div>
      </section>
      <!-- 19 -->
      <section class="card">
        <h3>Q19. Why did Williams name the settlement ‚ÄúProvidence‚Äù?</h3>
        <div class="options">
          <label><input type="radio" name="q19" value="a"> a) To honor a Dutch patron</label>
          <label><input type="radio" name="q19" value="b" data-correct> b) Gratitude for God‚Äôs providential care in his deliverance</label>
          <label><input type="radio" name="q19" value="c"> c) Because of rich mines</label>
          <label><input type="radio" name="q19" value="d"> d) Royal command</label>
          <label><input type="radio" name="q19" value="e"> e) To honor King Charles I</label>
        </div>
      </section>
      <!-- 20 -->
      <section class="card">
        <h3>Q20. Which legacy is most associated with Rhode Island under Williams?</h3>
        <div class="options">
          <label><input type="radio" name="q20" value="a"> a) Slave-based plantation aristocracy</label>
          <label><input type="radio" name="q20" value="b" data-correct> b) Early model of religious liberty and church‚Äìstate separation</label>
          <label><input type="radio" name="q20" value="c"> c) Theocratic rule by ministers</label>
          <label><input type="radio" name="q20" value="d"> d) Spanish alliance</label>
          <label><input type="radio" name="q20" value="e"> e) Military dictatorship</label>
        </div>
      </section>

      <!-- 21 (aberta) -->
      <section class="card">
        <h3>Q21. (Open) Cite one GIA key value present in the Mayflower Compact and explain it in 1‚Äì2 sentences.</h3>
        <textarea name="q21" class="writing" placeholder="Ex.: Integrity‚Äîassumir compromisso com o bem comum, etc."></textarea>
      </section>
      <!-- 22 (aberta) -->
      <section class="card">
        <h3>Q22. (Open) Em 2‚Äì3 frases, explique como a experi√™ncia de Roger Williams na neve e com as tribos refor√ßa a ideia ‚ÄúGod provides‚Äù.</h3>
        <textarea name="q22" class="writing" placeholder="Use fatos: fuga no inverno de 1636; acolhimento; funda√ß√£o de Providence..."></textarea>
      </section>

      <!-- Admin -->
      <section class="card">
        <h3>Results & Admin</h3>
        <p class="muted small">Teacher only.</p>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="downloadCsvBtn" disabled>Download CSV</button>
          <button id="resetBtn" class="icon-btn">Reset</button>
        </div>
      </section>
    </form>
  </main>

  <script>
  // ===== Tema =====
  (function(){
    const root = document.documentElement;
    const saved = localStorage.getItem('theme') || 'light';
    root.setAttribute('data-theme', saved);
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
  })();

  // ===== Config =====
  const DEFAULT_MINUTES = 30;
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzWovrGHidKrd0HCXmH5BgGn-7_D-T_-VhWQ1IKXh68W1cvp4Q1s9d8WVLckKvy5fn96g/exec';

  // ===== State =====
  let started = false, ended = false;
  let startTime = null, endTime = null, timerInterval = null;
  let secondsLeft = DEFAULT_MINUTES * 60;

  // Anti-cheat
  let tabSwitches = 0, blurCount = 0, isBlurred = false, blurStart = null, totalBlurMs = 0;
  let copyCount = 0, pasteCount = 0, findCount = 0;

  // DOM
  const submitBtn = document.getElementById('submitBtn');
  const timerEl = document.getElementById('timer');
  const form = document.getElementById('quizForm');
  const nameInput = document.getElementById('studentName');
  const testIdInput = document.getElementById('testId');
  const focusFlag = document.getElementById('focusFlag');
  const tabCountEl = document.getElementById('tabCount');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const resetBtn = document.getElementById('resetBtn');
  const toast = document.getElementById('toast');

  // Modal
  const modalName = document.getElementById('modalName');
  const acceptBtnEl = document.getElementById('acceptBtn');
  document.body.style.overflow = 'hidden';

  // trava form at√© iniciar
  [...form.elements].forEach(el=>el.disabled = true);

  function showToast(msg){ toast.textContent = msg || 'A√ß√£o registrada.'; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1500); }
  function fmt(secs){ const m=String(Math.floor(secs/60)).padStart(2,'0'); const s=String(secs%60).padStart(2,'0'); return `${m}:${s}`; }
  timerEl.textContent = fmt(secondsLeft);
  function tick(){ secondsLeft--; if(secondsLeft<0) secondsLeft=0; timerEl.textContent = fmt(secondsLeft); if(secondsLeft===0){ autoSubmit('time'); } }
  function startTimer(){ clearInterval(timerInterval); timerInterval = setInterval(tick, 1000); }

  function startTest(){
    started = true; startTime = new Date();
    nameInput.disabled = true; testIdInput.disabled = true;
    submitBtn.disabled = false;
    // habilita formul√°rio
    [...form.elements].forEach(el=>el.disabled = false);
    setTimeout(()=>{ [...form.elements].forEach(el=>el.disabled=false); }, 0);
    startTimer();

    // bloqueios
    document.addEventListener('copy', (e)=>{ copyCount++; e.preventDefault(); showToast('C√≥pia bloqueada.'); });
    document.addEventListener('cut', (e)=>{ e.preventDefault(); showToast('Recorte bloqueado.'); });
    document.addEventListener('paste', (e)=>{ pasteCount++; e.preventDefault(); showToast('Colagem bloqueada.'); });
    document.addEventListener('keydown', (e)=>{
      const k=e.key.toLowerCase(); const ctrl=e.ctrlKey||e.metaKey;
      if (ctrl && (k==='c'||k==='v'||k==='x'||k==='s'||k==='p'||k==='f')) { e.preventDefault(); showToast('Atalho bloqueado.'); }
      if (k==='f11'){ e.preventDefault(); showToast('F11 bloqueado.'); }
    }, {capture:true});
    document.addEventListener('contextmenu', (e)=> e.preventDefault());
  }

  // ===== Corre√ß√£o autom√°tica (conta apenas MC/T-F; abertas v√£o no payload) =====
  function grade(){
    const answers = {}; let totalCorrect = 0, totalPossible = 0;
    const radios = form.querySelectorAll('input[type=radio]');
    const groups = new Set([...radios].map(r=>r.name));
    groups.forEach(name=>{
      const checked = form.querySelector(`input[type=radio][name="${name}"]:checked`);
      const correct = form.querySelector(`input[type=radio][name="${name}"][data-correct]`);
      answers[name] = checked ? checked.value : null;
      if (correct){ totalPossible++; if (checked && checked === correct) totalCorrect++; }
    });
    // abertas
    const texts = form.querySelectorAll('textarea[name]');
    texts.forEach(t=>{ answers[t.name] = t.value.trim(); });
    return { answers, score: { totalCorrect, totalPossible } };
  }

  function collectPayload(reason='manual'){
    const g = grade();
    const now = new Date();
    const studentNameSafe = (nameInput.value || '').trim() || '(no name)';
    return {
      testId: (testIdInput.value.trim() || 'Pilgrims-Roger-Quiz-v1'),
      studentName: studentNameSafe,
      startISO: startTime?.toISOString() || null,
      endISO: now.toISOString(),
      durationSec: startTime ? Math.round((now - startTime)/1000) : null,
      reason,
      score: g.score,
      answers: g.answers,
      focus: { tabSwitches, blurCount, totalBlurMs, copyCount, pasteCount, findCount }
    };
  }

  function toCSV(obj){
    const s = obj;
    const row = [
      new Date().toISOString(), s.testId, JSON.stringify(s.studentName), s.startISO, s.endISO, s.durationSec,
      s.score.totalCorrect, s.score.totalPossible,
      JSON.stringify(s.answers)
    ];
    const header = [
      'timestamp','testId','studentName','startISO','endISO','durationSec',
      'correct','possible','answers'
    ];
    return header.join(',') + '\n' + row.join(',');
  }

  // ===== Envio robusto (fallback de Content-Type) =====
  async function sendResults(payload){
    async function tryPost(contentType){
      try{
        const res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type': contentType },
          body: JSON.stringify(payload)
        });
        return { ok: res.ok, status: res.status, text: await res.text() };
      }catch(err){
        return { ok:false, status:'FETCH_ERR', text:String(err) };
      }
    }
    let r = await tryPost('text/plain'); // compat√≠vel com muitos doPost
    if(!r.ok){ console.warn('POST text/plain falhou, tentando application/json‚Ä¶', r); r = await tryPost('application/json'); }
    if(r.ok){ showToast('Enviado ‚úî (HTTP ' + r.status + ')'); } else { showToast('Falha no envio ‚úñ (HTTP ' + r.status + ')'); }
    console.log('POST result:', r.status, r.text?.slice(0,300));
    return { posted: r.ok, status: r.status, responseText: r.text };
  }

  function downloadCSV(name, csv){
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${(name||'anonymous').replace(/\s+/g,'_')}_PilgrimsRoger_Quiz.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function lockTest(){
    [...form.elements].forEach(el=>el.disabled = true);
    submitBtn.disabled = true; downloadCsvBtn.disabled = false;
    document.getElementById('notes').textContent = 'Locked. Answers recorded.';
    document.querySelectorAll('section.card').forEach(sec=>sec.classList.add('strike'));
  }

  async function finalize(reason){
    if(ended) return; ended = true; endTime = new Date(); clearInterval(timerInterval);
    const payload = collectPayload(reason);
    const csv = toCSV(payload);
    const postRes = await sendResults(payload);
    downloadCSV(payload.studentName || 'anonymous', csv);
    lockTest();
    try{ if(document.fullscreenElement) document.exitFullscreen(); }catch(e){}
    console.log('Result payload:', payload, 'POST:', postRes);
  }
  function autoSubmit(reason){ finalize(reason); }

  // Eventos b√°sicos
  submitBtn.addEventListener('click', ()=> finalize('manual'));
  downloadCsvBtn.addEventListener('click', ()=>{
    const csv = toCSV(collectPayload('download-only'));
    downloadCSV((nameInput.value || '').trim() || 'anonymous', csv);
  });
  resetBtn.addEventListener('click', ()=> location.reload());

  // Anti-cheat leve
  document.addEventListener('visibilitychange', ()=>{
    if(!started || ended) return;
    if(document.visibilityState === 'hidden'){
      tabSwitches++; tabCountEl.textContent = `Contador de Aba: ${tabSwitches}`;
      focusFlag.textContent = 'Focus LOST';
      isBlurred = true; blurStart = Date.now();
      showToast('Troca de aba registrada.');
    } else {
      focusFlag.textContent = 'Foco OK';
      if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
    }
  });

  // Modal: valida o nome e inicia
  function isValidFullName(n){ const t=(n||'').trim().replace(/\s+/g,' '); const parts=t.split(' ').filter(p=>p.length>=2); return parts.length>=2; }
  modalName.addEventListener('input', ()=>{ acceptBtnEl.disabled = !isValidFullName(modalName.value); });
  document.getElementById('acceptBtn').addEventListener('click', async ()=>{
    const fullName = (modalName.value || '').trim();
    const t = fullName.replace(/\s+/g,' ');
    if(!isValidFullName(t)){ modalName.setAttribute('aria-invalid','true'); modalName.focus(); return; }
    document.getElementById('studentName').value = t;
    const backdrop = document.getElementById('consentBackdrop'); if (backdrop) backdrop.remove(); document.body.style.overflow = '';
    startTest();
  });
  document.getElementById('declineBtn').addEventListener('click', ()=>{ window.location.href='about:blank'; });
  </script>
</body>
</html>
