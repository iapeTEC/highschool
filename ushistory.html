
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>US History Race ‚Äî Nationalism & Sectionalism</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.7); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-blue-50 to-sky-50">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-indigo-700">US History Race ‚Äî Nationalism & Sectionalism</h1>
      <div class="text-sm text-slate-600" id="status"></div>
    </header>

    <!-- Screens -->
    <main id="screen-home" class="glass rounded-2xl shadow p-6 md:p-8">
      <p class="text-slate-700 mb-4">Play in pairs. First correct answer wins the round. 2-minute timer. Works for ~10‚Äì20 players using a lightweight, serverless backend (Firebase) from a static site.</p>
      <ol class="list-decimal list-inside text-slate-700 mb-6">
        <li>Create a room (host/teacher) or join one (students).</li>
        <li>Host clicks <span class="font-semibold">Start Round</span> to auto-pair players.</li>
        <li>Each pair gets a question. First correct click shows ‚ÄúYou got it!‚Äù. Opponent sees ‚ÄúNot this time‚Äù.</li>
      </ol>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Create Room -->
        <div class="rounded-xl border border-indigo-100 bg-white/70 p-5 shadow-sm">
          <h2 class="font-semibold text-indigo-700 mb-2">Create Room (Host)</h2>
          <label class="block mb-2 text-sm text-slate-600">Your name</label>
          <input id="hostName" class="w-full rounded-xl border p-2 mb-3" placeholder="Ms. Smith" />
          <button id="btnCreateRoom" class="w-full rounded-xl bg-indigo-600 text-white py-2 font-semibold hover:bg-indigo-700">Create Room</button>
          <p class="text-xs text-slate-500 mt-2">Share the room code with students. Keep this tab open to control rounds.</p>
        </div>
        <!-- Join Room -->
        <div class="rounded-xl border border-indigo-100 bg-white/70 p-5 shadow-sm">
          <h2 class="font-semibold text-indigo-700 mb-2">Join Room (Players)</h2>
          <label class="block mb-2 text-sm text-slate-600">Your name</label>
          <input id="playerName" class="w-full rounded-xl border p-2 mb-3" placeholder="Your name" />
          <label class="block mb-2 text-sm text-slate-600">Room code</label>
          <input id="roomCodeJoin" class="w-full rounded-xl border p-2 mb-3 uppercase" placeholder="ABCDE" />
          <button id="btnJoinRoom" class="w-full rounded-xl bg-sky-600 text-white py-2 font-semibold hover:bg-sky-700">Join Room</button>
        </div>
      </div>

      <details class="mt-6 text-slate-600">
        <summary class="cursor-pointer font-semibold text-slate-700">About privacy & fairness</summary>
        <p class="mt-2 text-sm">This static app uses <b>Firebase Firestore</b> for real-time sync. We do not collect IP addresses. ‚ÄúFirst click‚Äù is determined by the database‚Äôs <i>server timestamps</i> via transactions, which is fair for classroom use.</p>
      </details>
    </main>

    <!-- Lobby Screen -->
    <section id="screen-lobby" class="hidden glass rounded-2xl shadow p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-indigo-700">Lobby</h2>
        <div class="text-sm">Room: <span id="roomCodeDisplay" class="font-mono bg-indigo-100 text-indigo-700 px-2 py-1 rounded"></span></div>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-6">
        <div class="rounded-xl bg-white/70 border p-4">
          <h3 class="font-semibold text-slate-700 mb-2">Players</h3>
          <ul id="playerList" class="space-y-2 text-slate-700"></ul>
        </div>
        <div class="rounded-xl bg-white/70 border p-4">
          <h3 class="font-semibold text-slate-700 mb-2">Controls</h3>
          <p id="hostHint" class="text-sm text-slate-600 mb-3">Only host can start the round.</p>
          <label class="block mb-2 text-sm text-slate-600">Round length</label>
          <select id="roundSeconds" class="rounded-xl border p-2 mb-3">
            <option value="120" selected>2 minutes</option>
            <option value="90">90 seconds</option>
            <option value="60">60 seconds</option>
          </select>
          <button id="btnStartRound" class="rounded-xl bg-indigo-600 text-white py-2 px-4 font-semibold hover:bg-indigo-700 disabled:opacity-50" disabled>Start Round</button>
          <p class="mt-3 text-xs text-slate-500">Players are auto-paired in join order. Odd one out waits for next round.</p>
        </div>
      </div>
    </section>

    <!-- Match Screen -->
    <section id="screen-match" class="hidden glass rounded-2xl shadow p-6 md:p-8">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-bold text-indigo-700">Match</h2>
        <div class="text-sm">Room: <span id="roomCodeInMatch" class="font-mono bg-indigo-100 text-indigo-700 px-2 py-1 rounded"></span></div>
      </div>
      <div class="flex flex-wrap items-center gap-3 text-slate-700 mb-4">
        <span>Pair: <span id="pairLabel" class="font-semibold"></span></span>
        <span class="hidden md:inline">‚Ä¢</span>
        <span>Opponent: <span id="opponentName" class="font-semibold"></span></span>
        <span class="hidden md:inline">‚Ä¢</span>
        <span>Time left: <span id="countdown" class="font-mono bg-slate-900 text-white px-2 py-1 rounded"></span></span>
      </div>

      <div id="questionCard" class="rounded-2xl bg-white/80 border p-5 shadow">
        <div id="prompt" class="text-lg font-semibold text-slate-800 mb-3">Loading question‚Ä¶</div>
        <div id="options" class="grid md:grid-cols-2 gap-3"></div>
      </div>

      <div id="resultBanner" class="hidden mt-4 rounded-xl p-4 text-center font-semibold"></div>

      <div class="mt-6 flex items-center gap-3" id="postRoundControls">
        <button id="btnBackToLobby" class="rounded-xl bg-slate-700 text-white py-2 px-4 hover:bg-slate-800">Back to Lobby</button>
        <button id="btnNextRound" class="hidden rounded-xl bg-indigo-600 text-white py-2 px-4 hover:bg-indigo-700">Next Round (Host)</button>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">
      <p>Classroom set focuses on Nationalism & Sectionalism (1815‚Äì1850). Built as a static site using Firebase for real-time sync.</p>
    </footer>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <script>
    // =======================
    // üîß 1) Insert your Firebase config
    // Create a project at https://console.firebase.google.com
    // Enable Authentication (Anonymous) & Firestore (in test mode or set rules below)
    // =======================
    const firebaseConfig = {
      apiKey: "AIzaSyBZmeCdmzHUl8JYVDfwRRsiqG2ngGcoQU8",
      authDomain: "ushistory1-bf501.firebaseapp.com",
      projectId: "ushistory1-bf501",
      storageBucket: "ushistory1-bf501.firebasestorage.app",
      messagingSenderId: "188874720361",
      appId: "1:188874720361:web:61285fd7641440ce22cef8",
      measurementId: "G-QEF9CRZ0SB"
    };

    // Optional: Firestore Security Rules (paste in Firebase console > Firestore > Rules)
    /*
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /rooms/{code} {
          allow read: if true; // classroom visibility
          allow create: if true;
          allow update: if true; // keep it simple for class; for stricter control, restrict to hostId

          match /players/{uid} {
            allow read: if true;
            allow create: if request.resource.data.name is string &&
                           request.resource.data.name.size() > 0 && request.resource.data.name.size() <= 40;
            allow update, delete: if true;
          }

          match /matches/{matchId} {
            allow read: if true;
            // First answer wins logic is enforced client-side via transactions.
            // For stricter rules, consider writes only if resource.data.winner is null (not trivial in rules for per-field control).
            allow create, update: if true;
          }
        }
      }
    }
    */

    // =======================
    // 2) App State
    // =======================
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const $ = (sel) => document.querySelector(sel);
    const screenHome = $('#screen-home');
    const screenLobby = $('#screen-lobby');
    const screenMatch = $('#screen-match');

    const statusEl = $('#status');
    const playerListEl = $('#playerList');
    const roomCodeDisplay = $('#roomCodeDisplay');
    const roomCodeInMatch = $('#roomCodeInMatch');
    const pairLabel = $('#pairLabel');
    const opponentNameEl = $('#opponentName');
    const countdownEl = $('#countdown');
    const promptEl = $('#prompt');
    const optionsEl = $('#options');
    const resultBanner = $('#resultBanner');
    const hostHint = $('#hostHint');
    const btnStartRound = $('#btnStartRound');
    const btnNextRound = $('#btnNextRound');

    let me = { uid: null, name: null, isHost: false };
    let room = { code: null };
    let unsubPlayers = null;
    let myMatchUnsub = null;
    let currentMatch = null; // { id, data }
    let countdownTimer = null;

    const randCode = () => Math.random().toString(36).slice(2, 7).toUpperCase();
    const shuffle = (arr) => arr.map(x=>[Math.random(), x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

    // =======================
    // 3) History Question Bank (Nationalism & Sectionalism)
    // Types: 'person->achievement', 'year->event', 'term->definition'
    // =======================
    const Q = [];

    // Person -> Achievement
    Q.push({
      type: 'person',
      prompt: 'Who championed the American System and brokered major compromises (1820, 1833)?',
      options: ['Andrew Jackson', 'Henry Clay', 'John C. Calhoun', 'James Monroe'],
      correct: 1,
      tag: 'American System / Compromises'
    });
    Q.push({
      type: 'person',
      prompt: 'Who led the ‚ÄúBank War‚Äù and signed the Indian Removal Act (1830)?',
      options: ['Andrew Jackson', 'Daniel Webster', 'Nicholas Biddle', 'John Quincy Adams'],
      correct: 0,
      tag: 'Age of Jackson'
    });
    Q.push({
      type: 'person',
      prompt: 'Which states‚Äô rights advocate helped articulate nullification?',
      options: ['John C. Calhoun', 'Henry Clay', 'James K. Polk', 'DeWitt Clinton'],
      correct: 0,
      tag: 'Nullification'
    });
    Q.push({
      type: 'person',
      prompt: 'Whose doctrine (1823) warned Europe against new colonization in the Americas?',
      options: ['James Monroe', 'James Madison', 'John Quincy Adams', 'Thomas Jefferson'],
      correct: 0,
      tag: 'Monroe Doctrine'
    });
    Q.push({
      type: 'person',
      prompt: 'Who presided over the Second Bank during the Bank War?',
      options: ['Nicholas Biddle', 'Alexander Hamilton', 'Henry Clay', 'Martin Van Buren'],
      correct: 0,
      tag: 'BUS'
    });
    Q.push({
      type: 'person',
      prompt: 'Who is associated with the telegraph and the 1844 message?',
      options: ['Robert Fulton', 'Samuel Morse', 'Eli Whitney', 'Cyrus McCormick'],
      correct: 1,
      tag: 'Market Revolution'
    });

    // Year -> Event
    Q.push({ type: 'year', prompt: 'What happened in 1820?', options: ['Erie Canal opens', 'Missouri Compromise', 'Monroe Doctrine', 'Nullification Crisis'], correct: 1, tag: 'Missouri Compromise' });
    Q.push({ type: 'year', prompt: 'What happened in 1823?', options: ['Trail of Tears', 'Bank recharter veto', 'Monroe Doctrine', 'Compromise Tariff'], correct: 2, tag: 'Monroe Doctrine' });
    Q.push({ type: 'year', prompt: 'What happened in 1825?', options: ['Erie Canal opens', 'Indian Removal Act', 'Nullification Crisis', 'Seneca Falls'], correct: 0, tag: 'Erie Canal' });
    Q.push({ type: 'year', prompt: 'What happened in 1830?', options: ['Indian Removal Act', 'Compromise Tariff', 'BUS charter expires', 'Telegraph message'], correct: 0, tag: 'Indian Removal Act' });
    Q.push({ type: 'year', prompt: 'What happened in 1832‚Äì33?', options: ['Missouri Compromise', 'Nullification Crisis & Force Bill', 'Monroe Doctrine', 'Kansas-Nebraska Act'], correct: 1, tag: 'Nullification' });
    Q.push({ type: 'year', prompt: 'What happened in 1836 (BUS)?', options: ['BUS charter expires federally', 'BUS created', 'BUS nationalized', 'BUS privatized permanently'], correct: 0, tag: 'BUS' });
    Q.push({ type: 'year', prompt: 'What happened in 1844?', options: ['Erie Canal opens', 'First telegraph message', 'Indian Removal Act', 'Compromise of 1850'], correct: 1, tag: 'Telegraph' });

    // Term -> Definition
    Q.push({ type: 'term', prompt: 'Define ‚ÄúAmerican System‚Äù.', options: ['Tariff + National Bank + Internal Improvements', 'Annexation of Texas', 'Doctrine against European trade', 'Abolitionist newspaper'], correct: 0, tag: 'American System' });
    Q.push({ type: 'term', prompt: 'Define ‚Äúnullification‚Äù.', options: ['State power to void a federal law', 'Court power to strike laws', 'President‚Äôs treaty power', 'Congress‚Äôs tariff power'], correct: 0, tag: 'Nullification' });
    Q.push({ type: 'term', prompt: '‚ÄúSectionalism‚Äù means‚Ä¶', options: ['Loyalty to the nation', 'Loyalty to a region', 'Loyalty to a party', 'Loyalty to a court'], correct: 1, tag: 'Sectionalism' });

    // =======================
    // 4) Firebase Auth
    // =======================
    auth.signInAnonymously().then(() => {
      me.uid = auth.currentUser.uid;
      statusEl.textContent = 'Signed in (anonymous).';
    }).catch(err => {
      console.error(err);
      statusEl.textContent = 'Auth error ‚Äî open console.';
    });

    // =======================
    // 5) UI Navigation helpers
    // =======================
    function show(screen) {
      for (const el of [screenHome, screenLobby, screenMatch]) el.classList.add('hidden');
      screen.classList.remove('hidden');
    }

    // =======================
    // 6) Room / Players
    // =======================
    async function createRoom(name) {
      const code = randCode();
      const roomRef = db.collection('rooms').doc(code);
      const hostKey = randCode();
      await roomRef.set({
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        code,
        hostId: me.uid,
        hostKey,
        status: 'lobby',
        round: 0,
      });
      room.code = code; me.name = name; me.isHost = true;
      localStorage.setItem('uh_room', code);
      localStorage.setItem('uh_name', name);
      localStorage.setItem('uh_isHost', '1');

      // Add player
      await roomRef.collection('players').doc(me.uid).set({ name, joinedAt: firebase.firestore.FieldValue.serverTimestamp() });

      enterLobby(code);
    }

    async function joinRoom(code, name) {
      code = code.trim().toUpperCase();
      const roomRef = db.collection('rooms').doc(code);
      const snapshot = await roomRef.get();
      if (!snapshot.exists) { alert('Room not found.'); return; }
      room.code = code; me.name = name; me.isHost = false;
      localStorage.setItem('uh_room', code);
      localStorage.setItem('uh_name', name);
      localStorage.removeItem('uh_isHost');
      await roomRef.collection('players').doc(me.uid).set({ name, joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
      enterLobby(code);
    }

    function enterLobby(code) {
      roomCodeDisplay.textContent = code;
      show(screenLobby);
      btnStartRound.disabled = !me.isHost;
      hostHint.textContent = me.isHost ? 'You are the host. Start when ready.' : 'Waiting for host to start the round‚Ä¶';

      const roomRef = db.collection('rooms').doc(code);

      if (unsubPlayers) unsubPlayers();
      unsubPlayers = roomRef.collection('players').orderBy('joinedAt').onSnapshot(snap => {
        playerListEl.innerHTML = '';
        snap.forEach(doc => {
          const li = document.createElement('li');
          li.className = 'px-3 py-2 rounded-xl bg-slate-100 flex items-center justify-between';
          li.innerHTML = `<span>${doc.data().name}</span>`;
          playerListEl.appendChild(li);
        });
      });
    }

    // =======================
    // 7) Start Round (Host): pair players & create matches
    // =======================
    async function startRound() {
      const seconds = parseInt(document.getElementById('roundSeconds').value, 10);
      const now = Date.now();
      const deadline = now + seconds * 1000;

      const roomRef = db.collection('rooms').doc(room.code);
      const playersSnap = await roomRef.collection('players').orderBy('joinedAt').get();
      const players = playersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      const pairs = [];
      for (let i = 0; i < players.length; i += 2) {
        if (i + 1 < players.length) pairs.push([players[i], players[i+1]]);
      }

      // Create a match per pair
      const batch = db.batch();
      const matchesRef = roomRef.collection('matches');
      const qset = shuffle(Q).slice(0, pairs.length);

      pairs.forEach((pair, idx) => {
        const mRef = matchesRef.doc(String(idx+1));
        const q = qset[idx];
        batch.set(mRef, {
          startedAt: firebase.firestore.FieldValue.serverTimestamp(),
          deadline,
          pair: pair.map(p => ({ id: p.id, name: p.name })),
          question: { prompt: q.prompt, options: q.options, correct: q.correct, tag: q.tag },
          winner: null,
          answeredBy: {},
        });
      });

      await batch.commit();

      // Update room round
      await roomRef.update({ round: firebase.firestore.FieldValue.increment(1), status: 'playing' });

      // Navigate each player to their match (clients auto-detect)
      attachMyMatchListener();
    }

    // Each client finds their match doc and listens
    function attachMyMatchListener() {
      if (!room.code) return;
      const roomRef = db.collection('rooms').doc(room.code);

      // Find my pair by scanning matches
      if (myMatchUnsub) myMatchUnsub();
      myMatchUnsub = roomRef.collection('matches').onSnapshot(snap => {
        let found = null;
        snap.forEach(doc => {
          const data = doc.data();
          const ids = (data.pair || []).map(x => x.id);
          if (ids.includes(me.uid)) found = { id: doc.id, data };
        });
        if (found) {
          currentMatch = found;
          openMatch(found);
        } else {
          // Not paired this round
          // Stay in lobby with a note
          hostHint.textContent = 'You might be waiting this round (odd number).';
          show(screenLobby);
        }
      });
    }

    function openMatch(match) {
      roomCodeInMatch.textContent = room.code;
      const { pair, question, deadline } = match.data;
      const meObj = pair.find(p => p.id === me.uid);
      const opp = pair.find(p => p.id !== me.uid);
      pairLabel.textContent = `${meObj?.name || 'You'} vs ${opp?.name || '‚Äî'}`;
      opponentNameEl.textContent = opp?.name || '‚Äî';

      // Render question
      promptEl.textContent = question.prompt;
      optionsEl.innerHTML = '';
      question.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'rounded-xl border bg-white hover:bg-indigo-50 py-2 px-3 text-left';
        btn.innerHTML = `<span class="font-semibold">${String.fromCharCode(65+idx)}.</span> ${opt}`;
        btn.onclick = () => tryAnswer(idx);
        optionsEl.appendChild(btn);
      });

      // Show screen
      show(screenMatch);
      resultBanner.classList.add('hidden');
      resultBanner.textContent = '';

      // Countdown
      if (countdownTimer) clearInterval(countdownTimer);
      function updateCountdown() {
        const ms = Math.max(0, (currentMatch?.data?.deadline || 0) - Date.now());
        const s = Math.floor(ms / 1000);
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        countdownEl.textContent = `${mm}:${ss}`;
        if (ms <= 0) {
          clearInterval(countdownTimer);
          lockUI();
          revealIfNoWinner();
        }
      }
      currentMatch.data.deadline = deadline; // ensure in local state
      updateCountdown();
      countdownTimer = setInterval(updateCountdown, 250);

      // Live updates for winner/answers
      const roomRef = db.collection('rooms').doc(room.code);
      db.collection('rooms').doc(room.code).collection('matches').doc(match.id)
        .onSnapshot(doc => {
          currentMatch = { id: doc.id, data: doc.data() };
          if (currentMatch.data.winner) {
            lockUI();
            showResult();
          }
        });

      // Host control: show Next Round
      if (me.isHost) {
        btnNextRound.classList.remove('hidden');
      } else {
        btnNextRound.classList.add('hidden');
      }
    }

    function lockUI() {
      // Disable option buttons
      optionsEl.querySelectorAll('button').forEach(b => b.disabled = true);
    }

    function showResult() {
      const w = currentMatch?.data?.winner;
      if (!w) return;
      resultBanner.classList.remove('hidden');
      if (w === me.uid) {
        resultBanner.className = 'mt-4 rounded-xl p-4 text-center font-semibold bg-green-600 text-white';
        resultBanner.textContent = 'You got it!';
      } else {
        resultBanner.className = 'mt-4 rounded-xl p-4 text-center font-semibold bg-slate-800 text-white';
        resultBanner.textContent = 'Not this time.';
      }
    }

    async function revealIfNoWinner() {
      const matchRef = db.collection('rooms').doc(room.code).collection('matches').doc(currentMatch.id);
      const snap = await matchRef.get();
      const data = snap.data();
      if (!data.winner) {
        resultBanner.classList.remove('hidden');
        resultBanner.className = 'mt-4 rounded-xl p-4 text-center font-semibold bg-amber-500 text-white';
        const correct = data.question.options[data.question.correct];
        resultBanner.textContent = `Time! Correct answer: ${correct}`;
        lockUI();
      }
    }

    // Try to answer using a transaction so first correct click wins
    async function tryAnswer(optionIndex) {
      const matchRef = db.collection('rooms').doc(room.code).collection('matches').doc(currentMatch.id);
      try {
        await db.runTransaction(async (tx) => {
          const doc = await tx.get(matchRef);
          if (!doc.exists) return;
          const data = doc.data();
          const now = Date.now();
          if (now > (data.deadline || 0)) return; // too late

          // Record my attempt (for transparency)
          const answeredBy = data.answeredBy || {};
          if (!answeredBy[me.uid]) {
            answeredBy[me.uid] = { optionIndex, at: firebase.firestore.FieldValue.serverTimestamp() };
          }

          if (!data.winner && optionIndex === data.question.correct) {
            // I am first correct
            tx.update(matchRef, { winner: me.uid, answeredBy });
          } else {
            // Just store my attempt if no winner yet
            tx.update(matchRef, { answeredBy });
          }
        });
      } catch (e) {
        console.error('Answer error', e);
      }
    }

    // Host: Next round ‚Üí just go back to lobby; host can start again
    document.getElementById('btnNextRound').addEventListener('click', () => {
      show(screenLobby);
    });

    document.getElementById('btnBackToLobby').addEventListener('click', () => {
      show(screenLobby);
    });

    // Buttons
    document.getElementById('btnCreateRoom').addEventListener('click', () => {
      const name = (document.getElementById('hostName').value || '').trim();
      if (!name) return alert('Enter your name');
      createRoom(name);
    });

    document.getElementById('btnJoinRoom').addEventListener('click', () => {
      const name = (document.getElementById('playerName').value || '').trim();
      const code = (document.getElementById('roomCodeJoin').value || '').trim();
      if (!name || !code) return alert('Enter name and room code');
      joinRoom(code, name);
    });

    document.getElementById('btnStartRound').addEventListener('click', () => {
      if (!me.isHost) return;
      startRound();
    });

    // Auto-recover session
    window.addEventListener('load', async () => {
      const savedRoom = localStorage.getItem('uh_room');
      const savedName = localStorage.getItem('uh_name');
      const isHost = !!localStorage.getItem('uh_isHost');
      if (savedRoom && savedName) {
        me.name = savedName; me.isHost = isHost; room.code = savedRoom;
        if (isHost) {
          // Ensure host is in players list
          await db.collection('rooms').doc(savedRoom).collection('players').doc(me.uid).set({ name: savedName, joinedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        }
        enterLobby(savedRoom);
        attachMyMatchListener();
      }
    });
  </script>
</body>
</html>
