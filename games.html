<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pontua√ß√£o de Grupos</title>
  <style>
    :root { --gap: 14px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0f172a; color: white; }
    .wrap { max-width: 950px; margin: 24px auto; padding: 20px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius); padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size: 22px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 18px 0 8px; opacity: .9; }
    label { display:block; font-size: 14px; opacity:.9; margin-bottom: 6px; }
    input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0b1220; color: #e5e7eb; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .grid4 { display:grid; grid-template-columns: repeat(4,1fr); gap: var(--gap); }
    .students { display:grid; grid-template-columns: 1fr 120px; gap: 8px 12px; align-items:center; }
    .pill { background:#0b1220; padding:8px 12px; border-radius:999px; border:1px solid #334155; display:inline-flex; gap:8px; align-items:center; }
    .btn { background:#22c55e; color:#06220f; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn:hover { filter: brightness(1.05); }
    .muted { opacity:.8; font-size:12px; }
    .totals { display:flex; gap:12px; flex-wrap:wrap; }
    .badge { background:#0b1220; border:1px solid #334155; padding:8px 10px; border-radius:10px; font-variant-numeric: tabular-nums; }
    .ok { color:#22c55e; }
    .err { color:#ef4444; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üèÅ Pontua√ß√£o de Grupos</h1>
      <div class="row">
        <div>
          <label>Selecione o grupo</label>
          <select id="group"></select>
        </div>
        <div>
          <label>Seu nome (opcional)</label>
          <input id="teacher" placeholder="Ex.: Prof. Bruno"/>
        </div>
      </div>

      <h2>Quatro categorias</h2>
      <div class="grid4">
        <div><label>Categoria 1</label><input type="number" id="c1" min="0" step="0.1" /></div>
        <div><label>Categoria 2</label><input type="number" id="c2" min="0" step="0.1" /></div>
        <div><label>Categoria 3</label><input type="number" id="c3" min="0" step="0.1" /></div>
        <div><label>Categoria 4</label><input type="number" id="c4" min="0" step="0.1" /></div>
      </div>

      <h2>Apresenta√ß√£o por aluno</h2>
      <div id="students" class="students"></div>

      <h2>Resumo</h2>
      <div class="totals">
        <div class="badge">M√©dia 4 categorias: <b id="avgCats">0</b></div>
        <div class="badge">M√©dia apresenta√ß√£o: <b id="avgPres">0</b></div>
        <div class="badge">Pontua√ß√£o da rodada: <b id="finalRound">0</b></div>
      </div>

      <div style="margin-top:16px; display:flex; gap:12px; align-items:center;">
        <button class="btn" id="submit">Salvar pontua√ß√£o</button>
        <span class="muted">A m√©dia de apresenta√ß√£o considera apenas quem tiver nota informada.</span>
      </div>
      <div id="msg" style="margin-top:12px"></div>
    </div>
  </div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbwkG8V6QO3cWhHHjrLUUn7SVlawbAjylR5tVLyyOQ_ezD3IGF4WobfXU06G9nK9r82r/exec'; // ex.: https://script.google.com/macros/s/AKfycb.../exec
let GROUPS = [];

function el(id){ return document.getElementById(id); }
function n(v){ const x = parseFloat(v); return isNaN(x) ? 0 : x; }
function round2(x){ return Math.round(x*100)/100; }

async function getJSON(url){
  // GET simples sem headers personalizados ‚Üí evita preflight
  const res = await fetch(url, { method: 'GET' });
  if (!res.ok) throw new Error('Erro de rede');
  return await res.json();
}
async function postFormJSON(url, payload){
  // POST simples (sem preflight): x-www-form-urlencoded
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ payload: JSON.stringify(payload) }).toString()
  });
  if (!res.ok) throw new Error('Erro de rede');
  return await res.json();
}

function compute(){
  const avgCats = (n(el('c1').value)+n(el('c2').value)+n(el('c3').value)+n(el('c4').value))/4;
  const presInputs = document.querySelectorAll('[data-pres]');
  const presVals = Array.from(presInputs).map(i=>n(i.value)).filter(v=>!Number.isNaN(v) && v!==0);
  const avgPres = presVals.length ? presVals.reduce((a,b)=>a+b,0)/presVals.length : 0;
  el('avgCats').textContent = round2(avgCats);
  el('avgPres').textContent = round2(avgPres);
  el('finalRound').textContent = round2(avgCats + avgPres);
}

function renderStudents(group){
  const box = el('students');
  box.innerHTML = '';
  (group.members||[]).forEach(name => {
    const rowName = document.createElement('div');
    rowName.textContent = name;
    const rowInput = document.createElement('input');
    rowInput.type = 'number'; rowInput.step = '0.1'; rowInput.min='0'; rowInput.dataset.pres='1'; rowInput.placeholder='Apresenta√ß√£o';
    rowInput.addEventListener('input', compute);
    box.appendChild(rowName); box.appendChild(rowInput);
  });
}

async function load(){
  try{
    const data = await getJSON(`${API_BASE}?route=groups`);
    GROUPS = data.groups||[];
    const sel = el('group'); sel.innerHTML='';
    GROUPS.forEach(g=>{
      const o = document.createElement('option'); o.value=g.id; o.textContent=g.name; sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{
      const g = GROUPS.find(x=>x.id===sel.value); renderStudents(g); compute();
    });
    if (GROUPS[0]){ sel.value = GROUPS[0].id; renderStudents(GROUPS[0]); }
    ['c1','c2','c3','c4'].forEach(id=> el(id).addEventListener('input', compute));
    const savedName = localStorage.getItem('teacherName'); if (savedName) el('teacher').value = savedName;
    el('teacher').addEventListener('change', ()=> localStorage.setItem('teacherName', el('teacher').value));
    compute();
  }catch(err){ el('msg').innerHTML = `<span class="err">${err.message}</span>`; }
}

async function submit(){
  const sel = el('group');
  const groupId = sel.value;
  const categories = ['c1','c2','c3','c4'].map(id => n(el(id).value));
  const presentations = Array.from(document.querySelectorAll('#students input'))
    .map((inp, idx) => ({ student: el('students').children[idx*2].textContent, score: n(inp.value) }))
    .filter(p => p.score>0);
  const payload = { action:'submitScore', groupId, categories, presentations, submittedBy: el('teacher').value||'' };
  try{
    const data = await postFormJSON(API_BASE, payload);
    el('msg').innerHTML = `<span class="ok">Salvo! Rodada = ${data.finalRound.toFixed(2)} (4 cat: ${data.avgCategories.toFixed(2)} / apr: ${data.presentationAvg.toFixed(2)})</span>`;
    // limpa inputs de apresenta√ß√£o para pr√≥xima rodada
    document.querySelectorAll('#students input').forEach(i=> i.value='');
    compute();
  }catch(err){ el('msg').innerHTML = `<span class="err">Falha ao salvar: ${err.message}</span>`; }
}

el('submit').addEventListener('click', submit);
load();
<script>
function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    s.onerror = () => { delete window[cb]; reject(new Error('Falha JSONP')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
</script>

</script>
</body>
</html>
