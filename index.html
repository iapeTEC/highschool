<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <!-- PWA / ícones -->
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Chamada PG">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
  <link rel="icon" href="./icons/favicon.ico">
  <link rel="manifest" href="./site.webmanifest">
  <meta name="theme-color" content="#1a1a1a">

  <title>Dashboard — High School</title>
  <link rel="stylesheet" href="styleApontamento.css">

  <style>
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
    .menu a { color:#9b59b6; text-decoration:none; font-weight:700; padding:8px 10px; border:1px solid #9b59b6; border-radius:6px; }
    .menu a:hover { background:#9b59b6; color:#fff; }

    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .botao { background:#9b59b6; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; font-weight:bold; }
    .tiny { font-size:.9em; opacity:.8 }

    .list { display:flex; flex-direction:column; gap:10px; }
    .item { display:grid; grid-template-columns:64px 1fr; gap:12px; align-items:center; background:#2c2c2c; border-radius:12px; padding:12px; }
    .avatar { width:64px; height:64px; border-radius:50%; object-fit:cover; border:2px solid #9b59b6; background:#1a1a1a; }

    .name { font-weight:700; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; font-size:.95em; opacity:.85; }

    .track { position:relative; height:14px; background:#3d3d3d; border-radius:999px; overflow:hidden; border:1px solid #444; }
    .fill  { position:absolute; inset:0; width:0%; background:#2ecc71; }
    .runner{ position:absolute; top:50%; translate:-50% -50%; width:24px; height:24px; border-radius:50%; border:2px solid #2c2c2c; box-shadow:0 0 0 3px rgba(155,89,182,.25); overflow:hidden }
    .runner img{ width:100%; height:100%; object-fit:cover; border-radius:50% }

    .barRow{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; margin-top:6px }
    .barNote{ font:600 12px/1 system-ui; opacity:.8 }
  </style>

  <!-- libs para PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Dashboard — High School (corrida: quem tem <u>menos</u> falta)</h1>
      <nav class="menu">
        <a href="./rollcall.html">Ir para a Chamada</a>
      </nav>
    </div>

    <div class="controls">
      <button class="botao" id="btnRefresh">Atualizar dados</button>
      <button class="botao" id="btnPdf">Relatório (PDF)</button>
      <span class="tiny" id="lastRefresh"></span>
    </div>

    <div class="list" id="lista"></div>
  </div>

  <script>
    // ===== CONFIG =====
    const GROUP = 'PG6';
    const API_KEY = 'AIzaSyBuxhNxlYcLM88G6BggpNO8XG8w2BY9vSE';
    const SHEET_ID = '13hwIbPNJmHuLUxXfi-FJq4l-Gwl_mzIhkfPpl1N3A8c'; // mesma planilha
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyxix26KM2C5Q74SkdtYUjdjyf9Iv2ouG4iUOqDT-jORl8z4kExl-2tTv5LDQp9APgr/exec'; // (não usado aqui)

    const CLASS_HOURS = 3;           // cada aula
    const ABSENCE_LIMIT_HOURS = 18;  // pode faltar até 18h
    const CLASS_DURATION_MIN = CLASS_HOURS * 60;

    // ===== STATE =====
    let roster = [];        // [{nome, photo}]
    let attendance = [];    // Attendance (A..H)

    // ===== HELPERS =====
    function nowISO_TZ(tz='America/Recife'){
      const now = new Date();
      const y = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric'}).format(now);
      const m = new Intl.DateTimeFormat('en-CA', { timeZone: tz, month:'2-digit'}).format(now);
      const d = new Intl.DateTimeFormat('en-CA', { timeZone: tz, day:'2-digit'}).format(now);
      const hh= new Intl.DateTimeFormat('en-GB', { timeZone: tz, hour:'2-digit'}).format(now);
      const mm= new Intl.DateTimeFormat('en-GB', { timeZone: tz, minute:'2-digit'}).format(now);
      const ss= new Intl.DateTimeFormat('en-GB', { timeZone: tz, second:'2-digit'}).format(now);
      return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }

    // === ROSTER: lê A..C por linha (B = nome; C = foto preferencial; A = foto alternativa); mantém ordem alfabética SEMPRE
    async function fetchRoster(){
      const base  = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values`;
      const range = `${GROUP}!A2:C`;
      const res   = await fetch(`${base}/${encodeURIComponent(range)}?key=${API_KEY}`);

      if (!res.ok) {
        const errText = await res.text().catch(()=> '');
        console.warn('Sheets API (roster) falhou:', res.status, errText);
        roster = []; // sem fallback aqui para evitar desencontro de nomes/fotos
        return;
      }

      const { values = [] } = await res.json();
      const pickUrl = s => (s && /^https?:\/\//i.test(s.trim())) ? s.trim() : '';

      roster = values
        .map(r => {
          const a = (r[0] || '').trim(); // foto alternativa (antes do nome)
          const b = (r[1] || '').trim(); // NOME (obrigatório)
          const c = (r[2] || '').trim(); // foto preferida (ao lado do nome)
          if (!b) return null;
          const photo = pickUrl(c) || pickUrl(a) || '';
          return { nome: b, photo };
        })
        .filter(Boolean)
        .sort((x,y) => x.nome.localeCompare(y.nome, 'pt-BR')); // <-- SEMPRE alfabético
    }

    async function fetchAttendance(){
      const base = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values`;
      const r = await fetch(`${base}/${encodeURIComponent('Attendance!A2:H')}?key=${API_KEY}`);
      if (!r.ok) { attendance = []; return; }
      const j = await r.json();
      attendance = (j.values||[]).map(a=>({
        ts: a[0]||'',            // Timestamp
        date: a[1]||'',          // yyyy-mm-dd
        group: a[2]||'',
        resp: a[3]||'',
        aluno: (a[4]||'').trim(),
        pres: Number(a[5]||0),   // 0/1
        arrival: a[6]||'',
        absentMin: Number(a[7]|| (a[5]==='0'? CLASS_DURATION_MIN: 0))
      }));
    }

    // === Totais: calcula faltas mas devolve lista em ORDEM ALFABÉTICA
    function computeTotals(){
      const by = new Map(); // nome => minutos de falta acumulados

      attendance.forEach(r=>{
        if (r.group !== GROUP) return;
        if (!r.aluno) return;
        const min = (r.pres===1) ? (r.absentMin||0) : CLASS_DURATION_MIN;
        by.set(r.aluno, (by.get(r.aluno)||0) + min);
      });

      // garante todos do roster
      roster.forEach(s => { if (!by.has(s.nome)) by.set(s.nome, 0); });

      const list = roster.map(s=>{
        const absMin = by.get(s.nome) || 0;
        const absH   = +(absMin / 60).toFixed(2);
        const canH   = Math.max(0, ABSENCE_LIMIT_HOURS - absH);
        const progress = Math.max(0, Math.min(1, canH / ABSENCE_LIMIT_HOURS));
        return { nome:s.nome, photo:s.photo, faltaH:absH, podeH:+canH.toFixed(2), progress };
      });

      // ORDEM FINAL: alfabética, sempre
      list.sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'));
      return list;
    }

    function render(){
      const lista = document.getElementById('lista');
      const data = computeTotals();
      lista.innerHTML = '';

      data.forEach(st=>{
        const item = document.createElement('div'); item.className='item';
        const img = document.createElement('img'); img.className='avatar'; img.src = st.photo || 'https://i.imgur.com/0Z8FQ0g.png'; img.alt=st.nome;

        const main = document.createElement('div');
        const name = document.createElement('div'); name.className='name'; name.textContent = st.nome;
        const stats = document.createElement('div'); stats.className='stats';
        stats.innerHTML = `Faltas: <b>${st.faltaH}h</b> • Pode faltar: <b>${st.podeH}h</b> (limite ${ABSENCE_LIMIT_HOURS}h)`;

        const track = document.createElement('div'); track.className='track';
        const fill  = document.createElement('div'); fill.className='fill';
        const pct = Math.round(st.progress*100);
        fill.style.width = pct + '%'; track.appendChild(fill);
        const runner = document.createElement('div'); runner.className='runner'; runner.style.left = pct + '%';
        const rimg = document.createElement('img'); rimg.src = img.src; runner.appendChild(rimg); track.appendChild(runner);

        const barRow = document.createElement('div'); barRow.className='barRow';
        const note = document.createElement('div'); note.className='barNote'; note.textContent = `${st.podeH}h restantes`;
        barRow.appendChild(track); barRow.appendChild(note);

        main.appendChild(name); main.appendChild(stats); main.appendChild(barRow);

        item.appendChild(img); item.appendChild(main);
        lista.appendChild(item);
      });
      document.getElementById('lastRefresh').textContent = 'Atualizado em ' + nowISO_TZ('America/Recife');
    }

    function generatePdf(){
      const { jsPDF } = window.jspdf;
      const data = computeTotals(); // já vem alfabético
      const doc = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Relatório de Faltas (horas) — PG6', 40, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text('Regra: 1 aula = 3h • Limite: 18h • Tolerância atraso: 5 min', 40, 58);
      const body = data.map(st=> [st.nome, `${st.faltaH} h`, `${st.podeH} h`]);
      doc.autoTable({
        startY:78,
        head: [['Aluno','Faltas (h)','Ainda pode faltar (h)']],
        body,
        styles:{fontSize:10, cellPadding:6},
        headStyles:{ fillColor:[30,30,36], textColor:255 },
        alternateRowStyles:{ fillColor:[245,245,248] },
        margin:{ left:40, right:40 }
      });
      doc.save('faltas_PG6.pdf');
    }

    async function refreshAll(){
      const btn = document.getElementById('btnRefresh');
      try {
        if (btn) { btn.disabled = true; btn.textContent = 'Atualizando...'; }
        await fetchRoster();
        await fetchAttendance();
        render();
      } catch (e) {
        console.error(e);
        document.getElementById('lista').innerHTML = '<div class="resultado erro">Erro ao carregar dados (verifique permissões e a aba PG6).</div>';
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Atualizar dados'; }
      }
    }

    // ===== INIT =====
    (async function(){
      document.getElementById('btnRefresh').onclick = refreshAll;
      document.getElementById('btnPdf').onclick = generatePdf;
      await refreshAll();
    })();
  </script>
</body>
</html>

